//PremiÃ¨re version de la fonction checkout
    // public function checkout($inscriptionId)
    // {
    //     if (!Auth::check()) {
    //         Log::warning('Tentative non authentifiÃ©e de paiement.');
    //         abort(403, 'Vous devez Ãªtre connectÃ© pour effectuer un paiement.');
    //     }

    //     $inscription = Inscription::find($inscriptionId);

    //     if (!$inscription) {
    //         Log::error("Inscription introuvable (ID: $inscriptionId)");
    //         abort(404, 'Inscription non trouvÃ©e.');
    //     }

    //     if ((int)$inscription->user_id !== (int)Auth::id()) {
    //         Log::warning('AccÃ¨s interdit Ã  une inscription appartenant Ã  un autre utilisateur.', [
    //             'utilisateur_connectÃ©' => Auth::id(),
    //             'utilisateur_inscription' => $inscription->user_id,
    //         ]);
    //         abort(403, 'AccÃ¨s interdit.');
    //     }


    //     if ($inscription->status !== 'AcceptÃ©') {
    //         Log::info("Tentative de paiement pour une inscription non acceptÃ©e (Status: {$inscription->status})", [
    //             'inscription_id' => $inscription->id,
    //         ]);
    //         return redirect()->back()->with('warning', 'Le paiement nâ€™est possible que pour les inscriptions acceptÃ©es.');
    //     }

    //     $formation = $inscription->formation;

    //     if (!$formation || !$formation->stripe_price_id) {
    //         Log::error('Formation ou prix Stripe manquant pour lâ€™inscription.', [
    //             'formation_id' => optional($formation)->id,
    //             'stripe_price_id' => optional($formation)->stripe_price_id,
    //         ]);
    //         return redirect()->back()->with('error', 'Impossible de procÃ©der au paiement : formation non valide.');
    //     }

    //     Stripe::setApiKey(config('services.stripe.secret'));

    //     try {
    //         $session = Session::create([
    //             'line_items' => [[
    //                 'price' => $formation->stripe_price_id,
    //                 'quantity' => 1,
    //             ]],
    //             'mode' => 'payment',
    //             'success_url' => route('payment.success', [
    //                 'inscription' => $inscriptionId,
    //                 'session_id' => '{CHECKOUT_SESSION_ID}'
    //             ]),
    //             'cancel_url' => route('payment.cancel'),
    //             'metadata' => [
    //                 'inscription_id' => $inscriptionId,
    //                 'user_id' => Auth::id()
    //             ]
    //         ]);

    //         Log::info('Stripe session crÃ©Ã©e avec succÃ¨s.', [
    //             'session_id' => $session->id,
    //             'session_url' => $session->url
    //         ]);

    //         return redirect($session->url);

    //     } catch (\Exception $e) {
    //         Log::error('Stripe Checkout Error: ' . $e->getMessage());
    //         return redirect()->back()->with('error', 'Une erreur est survenue pendant le paiement. Veuillez rÃ©essayer.');
    //     }

    // }

    //Force le client Stripe Ã  utiliser le bon fichier de certificat
    // public function checkout($inscriptionId)
    // {
    //     if (!Auth::check()) {
    //         Log::warning('âŒ Utilisateur non authentifiÃ©');
    //         abort(403, 'Vous devez Ãªtre connectÃ© pour effectuer un paiement.');
    //     }

    //     Log::info("ğŸ” DÃ©marrage du paiement pour l'inscription ID: $inscriptionId");

    //     $inscription = Inscription::find($inscriptionId);

    //     if (!$inscription) {
    //         Log::error("âŒ Inscription introuvable (ID: $inscriptionId)");
    //         abort(404, 'Inscription non trouvÃ©e.');
    //     }

    //     if ((int)$inscription->user_id !== (int)Auth::id()) {
    //         Log::warning('âŒ AccÃ¨s interdit Ã  une autre inscription', [
    //             'connectÃ©' => Auth::id(),
    //             'propriÃ©taire' => $inscription->user_id,
    //         ]);
    //         abort(403, 'AccÃ¨s interdit.');
    //     }

    //     if ($inscription->status !== 'AcceptÃ©') {
    //         Log::info("â›” Inscription non Ã©ligible au paiement (Status: {$inscription->status})", [
    //             'inscription_id' => $inscription->id,
    //         ]);
    //         return redirect()->back()->with('warning', 'Le paiement nâ€™est possible que pour les inscriptions acceptÃ©es.');
    //     }

    //     $formation = $inscription->formation;

    //     if (!$formation || !$formation->stripe_price_id) {
    //         Log::error('âŒ Formation ou prix Stripe manquant', [
    //             'formation_id' => optional($formation)->id,
    //             'stripe_price_id' => optional($formation)->stripe_price_id,
    //         ]);
    //         return redirect()->back()->with('error', 'Impossible de procÃ©der au paiement : formation non valide.');
    //     }

    //     // Force le client Stripe Ã  utiliser le bon fichier de certificat
    //     putenv('CURL_CA_BUNDLE=' . base_path('storage/app/certs/cacert.pem'));
    //     ini_set('curl.cainfo', base_path('storage/app/certs/cacert.pem'));
    //     ini_set('openssl.cafile', base_path('storage/app/certs/cacert.pem'));


    //     $caBundle = env('CURL_CA_BUNDLE');
    
    //     if (config('app.env') === 'local') {
    //         if ($caBundle && file_exists($caBundle)) {
    //             \Stripe\Stripe::setCABundlePath($caBundle);
    //             Log::info("ğŸ”’ Utilisation du bundle de certificats local: $caBundle");
    //         } else {
    //             // Solution de secours pour les environnements sans bundle
    //             Log::warning("âš ï¸ Bundle de certificats introuvable, tentative de solution alternative");
                
    //             // Tentative de rÃ©cupÃ©ration du bundle systÃ¨me
    //             $systemCaBundle = ini_get('curl.cainfo') ?: ini_get('openssl.cafile');
                
    //             if ($systemCaBundle && file_exists($systemCaBundle)) {
    //                 \Stripe\Stripe::setCABundlePath($systemCaBundle);
    //                 Log::info("ğŸ”’ Utilisation du bundle systÃ¨me: $systemCaBundle");
    //             } else {
    //                 // DÃ©sactivation SSL uniquement en dernier recours
    //                 \Stripe\Stripe::setVerifySslCerts(false);
    //                 Log::warning("âš ï¸ VÃ©rification SSL dÃ©sactivÃ©e (dernier recours)");
    //             }
    //         }
    //     }

    //     Stripe::setApiKey(config('services.stripe.secret'));

    //     Log::info("ğŸ”’ Environnement SSL modifiÃ© manuellement : ", [
    //         'curl.cainfo' => ini_get('curl.cainfo'),
    //         'openssl.cafile' => ini_get('openssl.cafile'),
    //         'CURL_CA_BUNDLE' => getenv('CURL_CA_BUNDLE')
    //     ]);


    //     try {
    //         Log::info('âœ… CrÃ©ation de session Stripe...', [
    //             'formation' => $formation->id,
    //             'stripe_price_id' => $formation->stripe_price_id,
    //         ]);

    //         $session = Session::create([
    //             'line_items' => [[
    //                 'price' => $formation->stripe_price_id,
    //                 'quantity' => 1,
    //             ]],
    //             'mode' => 'payment',
    //             'success_url' => route('payment.success', [
    //                 'inscription' => $inscriptionId,
    //                 'session_id' => '{CHECKOUT_SESSION_ID}'
    //             ]),
    //             'cancel_url' => route('payment.cancel'),
    //             'metadata' => [
    //                 'inscription_id' => $inscriptionId,
    //                 'user_id' => Auth::id()
    //             ],
    //             'customer_email' => Auth::user()->email, // Ajout recommandÃ©
    //             'client_reference_id' => 'insc_'.$inscriptionId, // Ajout recommandÃ©
    //         ]);

    //         Log::info('âœ… Session Stripe crÃ©Ã©e avec succÃ¨s.', [
    //             'session_id' => $session->id,
    //             'checkout_url' => $session->url
    //         ]);

    //         return redirect($session->url);

    //     } catch (\Exception $e) {
    //         Log::error('ğŸ’¥ Stripe Checkout Error: ' . $e->getMessage());
    //         return redirect()->back()->with('error', 'Une erreur est survenue pendant le paiement: '.$e->getMessage());
    //     }
    // }